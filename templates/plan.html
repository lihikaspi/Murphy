{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto pb-16">
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10 border-b border-slate-200 pb-8">
        <div>
            <div class="flex items-center gap-2 mb-2">
                <span class="px-2 py-0.5 bg-emerald-100 text-emerald-700 text-[10px] font-bold rounded-full uppercase tracking-wider">
                    Analysis Active
                </span>
                <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-bold rounded-full uppercase tracking-wider">
                    Version {{ session.get('current_v_idx', 0) + 1 }}
                </span>
            </div>
            <h1 class="text-3xl font-extrabold text-slate-900">Strategic Fortification Dashboard</h1>
        </div>
        <div class="flex items-center gap-6">
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                Current Severity: {{ user_input.pessimism }}
            </span>

            <div class="flex gap-3">
                <div class="relative group">
                    <div class="absolute right-0 mt-2 w-48 bg-white border rounded-xl shadow-xl hidden group-hover:block z-50">
                        {% for v in versions %}
                        <a href="/set_version/{{ loop.index0 }}" class="block px-4 py-2 text-xs hover:bg-slate-50 border-b last:border-0 {% if loop.index0 == session.get('current_v_idx') %}bg-slate-100 font-bold{% endif %}">
                            v{{ loop.index }} - {{ v.timestamp }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                <a href="/followup" class="px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">
                    Finish <i data-lucide="check-circle" class="w-4 h-4"></i>
                </a>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 h-[26rem] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b bg-slate-50/50 font-bold text-slate-700 text-xs flex items-center gap-2 uppercase tracking-wider">
                <i data-lucide="file-text" class="w-4 h-4"></i> Original Plan
            </div>
            <div class="p-6 overflow-y-auto text-sm text-slate-500 italic whitespace-pre-wrap leading-relaxed">
                {{ user_input.plan }}
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-red-100 h-[26rem] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b bg-red-50/30 font-bold text-red-700 text-xs flex items-center gap-2 uppercase tracking-wider">
                <i data-lucide="alert-octagon" class="w-4 h-4"></i> Identified Weaknesses
            </div>
            <div class="p-6 overflow-y-auto space-y-3">
                {% for p in current.problems %}
                <div class="p-4 bg-white rounded-xl border border-slate-100 flex justify-between items-start gap-4 hover:border-red-200 transition-colors">
                    <div class="flex-1">
                        <h4 class="font-bold text-slate-900 text-sm mb-1">{{ p.title }}</h4>
                        <p class="text-xs text-slate-500">{{ p.desc }}</p>
                    </div>
                    <div class="flex gap-1 shrink-0 binary-controls" data-type="problem" data-idx="{{ loop.index0 }}">
                        <button onclick="setBinary('problem', {{ loop.index0 }}, true, this)"
                                class="like-btn p-1.5 rounded-md transition-all
                                {% if p.liked == True %}
                                    bg-emerald-500 text-white shadow-md hover:bg-emerald-400
                                {% else %}
                                    text-slate-300 hover:text-emerald-500 hover:bg-emerald-50
                                {% endif %}">
                            <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                        </button>
                        <button onclick="setBinary('problem', {{ loop.index0 }}, false, this)"
                                class="dislike-btn p-1.5 rounded-md transition-all
                                {% if p.liked == False %}
                                    bg-rose-500 text-white shadow-md hover:bg-rose-400
                                {% else %}
                                    text-slate-300 hover:text-rose-500 hover:bg-rose-50
                                {% endif %}">
                            <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-indigo-100 h-[26rem] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b bg-indigo-50/30 font-bold text-indigo-700 text-xs flex items-center gap-2 uppercase tracking-wider">
                <i data-lucide="shield-check" class="w-4 h-4"></i> Revised Strategy
            </div>
            <div class="p-6 overflow-y-auto text-sm text-slate-800 leading-relaxed font-medium">
                {{ current.revised_plan }}
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-emerald-100 h-[26rem] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b bg-emerald-50/30 font-bold text-emerald-700 text-xs flex items-center gap-2 uppercase tracking-wider">
                <i data-lucide="sparkles" class="w-4 h-4"></i> Strategic Improvements
            </div>
            <div class="p-6 overflow-y-auto space-y-3">
                {% for i in current.improvements %}
                <div class="p-4 bg-white rounded-xl border border-slate-100 flex justify-between items-start gap-4 hover:border-emerald-200 transition-colors">
                    <div class="flex-1">
                        <h4 class="font-bold text-slate-900 text-sm mb-1">{{ i.title }}</h4>
                        <p class="text-xs text-slate-500">{{ i.desc }}</p>
                    </div>
                    <div class="flex gap-1 shrink-0 binary-controls" data-type="improvement" data-idx="{{ loop.index0 }}">
                        <button onclick="setBinary('improvement', {{ loop.index0 }}, true, this)"
                                class="like-btn p-1.5 rounded-md transition-all
                                {% if i.liked == True %}
                                    bg-emerald-500 text-white shadow-md hover:bg-emerald-400
                                {% else %}
                                    text-slate-300 hover:text-emerald-500 hover:bg-emerald-50
                                {% endif %}">
                            <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                        </button>
                        <button onclick="setBinary('improvement', {{ loop.index0 }}, false, this)"
                                class="dislike-btn p-1.5 rounded-md transition-all
                                {% if i.liked == False %}
                                    bg-rose-500 text-white shadow-md hover:bg-rose-400
                                {% else %}
                                    text-slate-300 hover:text-rose-500 hover:bg-rose-50
                                {% endif %}">
                            <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <section class="mb-16">
        <h2 class="text-xl font-bold text-slate-900 mb-8 px-2">Timeline Summary</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for choice in maze_choices %}
            <div class="relative bg-white rounded-xl border border-slate-200 p-6 shadow-sm hover-card">
                <div class="absolute -top-3 left-4 px-2 py-0.5 bg-indigo-600 text-white text-[10px] font-bold rounded uppercase tracking-wider z-10">
                    Obstacle {{ loop.index }}
                </div>

                <h5 class="font-bold text-slate-900 text-sm mb-2 leading-tight">{{ choice.title }}</h5>

                {% set option_text = choice.answer.split('[')[0].strip() %}
                <p class="text-xs text-slate-600 mb-4 italic leading-relaxed">
                    "{{ option_text }}"
                </p>

                {% if '[' in choice.answer %}
                <div class="flex flex-wrap gap-2 border-t border-slate-50 pt-3">
                    {% set scores = choice.answer.split('[')[1].split(']')[0].split(',') %}
                    {% for s in scores %}
                        {% set score_parts = s.split(':') %}
                        {% set label = score_parts[0].strip() %}
                        {% set val = score_parts[1].strip() | int %}

                        {% if label == 'Feasibility' %}
                            {% set color = 'text-emerald-600 bg-emerald-50' if val >= 8 else 'text-amber-600 bg-amber-50' if val >= 4 else 'text-rose-600 bg-rose-50' %}
                        {% else %}
                            {% set color = 'text-emerald-600 bg-emerald-50' if val <= 3 else 'text-amber-600 bg-amber-50' if val <= 7 else 'text-rose-600 bg-rose-50' %}
                        {% endif %}
                        <span class="text-[9px] font-black uppercase px-2 py-1 rounded {{ color }}">{{ label }}: {{ val }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>

    <section class="bg-slate-900 rounded-3xl p-10 text-white flex flex-col lg:flex-row gap-12 relative overflow-hidden">
        <i data-lucide="message-square" class="absolute -top-10 -right-10 w-48 h-48 text-white/5"></i>

        <div class="flex-1 relative z-10">
            <form id="refineForm" action="/refine" method="POST">
                <h3 class="text-2xl font-bold mb-4">Refine the Timeline</h3>
                <p class="text-slate-400 text-sm mb-6">Currently refining <b>Version {{ session.current_v_idx + 1 }}</b>. Changes will create a new version.</p>

                <textarea id="feedbackText" name="feedback" oninput="validateFeedback()" class="w-full h-32 bg-white/10 border border-white/20 rounded-2xl p-4 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none mb-4" placeholder="e.g. Focus more on organic growth..."></textarea>

                <div class="flex flex-col md:flex-row items-center gap-4">
                    <button id="sendBtn" type="submit" disabled class="px-8 py-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-500 transition-all disabled:opacity-40 disabled:cursor-not-allowed">
                        Update Analysis
                    </button>

                    <div class="flex-1">
                        <select name="pessimism" class="bg-white/10 border border-white/20 rounded-xl px-4 py-4 text-sm text-white focus:ring-2 focus:ring-indigo-500 outline-none w-full md:w-64 cursor-pointer">
                            {% for level in ["Optimistic", "Slightly Concerned", "Realistic", "Pessimistic", "Total Chaos"] %}
                            <option value="{{ level }}" class="text-slate-900" {% if user_input.pessimism == level %}selected{% endif %}>{{ level }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </form>
        </div>

        <div class="w-full lg:w-96 relative z-10 lg:border-l lg:border-white/10 lg:pl-12">
            <h4 class="font-bold text-slate-300 mb-6 flex items-center gap-2">
                <i data-lucide="history" class="w-4 h-4"></i> Notes History
            </h4>
            <div class="space-y-4 max-h-[350px] overflow-y-auto pr-4 custom-scroll">
                {% for v in versions|reverse %}
                {% set actual_idx = versions|length - 1 - loop.index0 %}
                <a href="/set_version/{{ actual_idx }}"
                   class="block p-4 rounded-xl border-l-4 transition-all hover:bg-white/5 group
                   {{ 'border-indigo-500 bg-white/10' if actual_idx == session.current_v_idx else 'border-transparent bg-white/5 opacity-60' }}">

                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-black uppercase tracking-widest {{ 'text-indigo-400' if actual_idx == session.current_v_idx else 'text-slate-500' }}">
                            version {{ actual_idx + 1 }}
                        </span>
                        <span class="text-[10px] text-slate-500 font-bold uppercase">{{ v.timestamp }}</span>
                    </div>

                    <p class="text-xs {{ 'text-white font-medium' if actual_idx == session.current_v_idx else 'text-slate-400' }} leading-relaxed italic line-clamp-2">
                        {{ v.notes }}
                    </p>

                    {% if actual_idx == session.current_v_idx %}
                    <span class="inline-block mt-2 text-[9px] font-bold text-indigo-400 uppercase tracking-tighter">Currently Viewing</span>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        </div>
    </section>
</div>

<script>
    // Requirement 7: Validate if send button should be enabled
    function validateFeedback() {
        const text = document.getElementById('feedbackText').value.trim();
        const sendBtn = document.getElementById('sendBtn');

        // Binary feedback check: any item has liked property as true/false
        const currentProblems = {{ current.problems | tojson }};
        const currentImps = {{ current.improvements | tojson }};
        const hasBinary = currentProblems.some(p => p.liked !== null) || currentImps.some(i => i.liked !== null);

        if (text.length > 0 || hasBinary) {
            sendBtn.disabled = false;
        } else {
            sendBtn.disabled = true;
        }
    }

    // Call on load to check existing binary feedback
    window.onload = validateFeedback;

    async function setBinary(type, idx, liked, btnElement) {
        const container = btnElement.closest('.binary-controls');
        const likeBtn = container.querySelector('.like-btn');
        const dislikeBtn = container.querySelector('.dislike-btn');

        const isAlreadyActive = (liked && btnElement.classList.contains('bg-emerald-500')) ||
                                (!liked && btnElement.classList.contains('bg-rose-500'));

        const finalLikedValue = isAlreadyActive ? null : liked;

        // Reset Like Button classes
        likeBtn.classList.remove('bg-emerald-500', 'hover:bg-emerald-400', 'text-white', 'shadow-md');
        likeBtn.classList.add('text-slate-300', 'hover:text-emerald-500', 'hover:bg-emerald-50');

        // Reset Dislike Button classes
        dislikeBtn.classList.remove('bg-rose-500', 'hover:bg-rose-400', 'text-white', 'shadow-md');
        dislikeBtn.classList.add('text-slate-300', 'hover:text-rose-500', 'hover:bg-rose-50');

        // Apply Active state
        if (finalLikedValue === true) {
            likeBtn.classList.remove('text-slate-300', 'hover:text-emerald-500', 'hover:bg-emerald-50');
            likeBtn.classList.add('bg-emerald-500', 'text-white', 'shadow-md', 'hover:bg-emerald-400');
        } else if (finalLikedValue === false) {
            dislikeBtn.classList.remove('text-slate-300', 'hover:text-rose-500', 'hover:bg-rose-50');
            dislikeBtn.classList.add('bg-rose-500', 'text-white', 'shadow-md', 'hover:bg-rose-400');
        }

        try {
            await fetch('/feedback_binary', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type, idx, liked: finalLikedValue})
            });
            validateFeedback();
        } catch (err) {
            console.error("Error updating feedback:", err);
        }
    }
</script>
{% endblock %}