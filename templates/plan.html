{% extends "base.html" %}

{% block content %}
<div class="max-w-8xl mx-auto pb-16">
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10 border-b border-slate-200 pb-8">
        <div>
            <div class="flex items-center gap-2 mb-2">
                <span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 text-[12px] font-bold rounded-full uppercase tracking-wider">
                    Version {{ session.get('current_v_idx', 0) + 1 }}
                </span>
                <span class="px-2 py-0.5 bg-orange-100 text-orange-700 text-[12px] font-bold rounded-full uppercase tracking-wider">
                    Current Severity: {{ user_input.pessimism }}
                </span>
            </div>
            <div class="flex items-center gap-3">
                <h1 class="text-3xl font-extrabold text-slate-900">Strategic Fortification Dashboard</h1>
                <button type="button" onclick="toggleHelpModal(true)"
                        class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-200 text-slate-500 hover:bg-slate-300 transition-all shadow-sm -mt-0.5"
                        title="Dashboard Instructions">
                    <i data-lucide="help-circle" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
        <div class="flex items-center gap-1 mb-8">
            <div class="flex gap-3">
                <div class="relative group">
                    <div class="absolute right-0 mt-2 w-48 bg-white border rounded-xl shadow-xl hidden group-hover:block z-50">
                        {% for v in versions %}
                        <a href="/set_version/{{ loop.index0 }}" class="block px-4 py-2 text-xs hover:bg-slate-50 border-b last:border-0 {% if loop.index0 == session.get('current_v_idx') %}bg-slate-100 font-bold{% endif %}">
                            v{{ loop.index }} - {{ v.timestamp }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                <a href="/followup" class="px-6 py-2 bg-emerald-600 text-white rounded-lg text-[16px] font-bold flex items-center gap-2 hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-100">
                    Finish <i data-lucide="check-circle" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 h-[18rem] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b bg-slate-50/50 font-bold text-slate-700 text-[14px] flex items-center gap-2 uppercase tracking-wider">
                <i data-lucide="file-text" class="w-4 h-4"></i> Original Plan
            </div>
            <div class="p-6 overflow-y-auto text-[15px] text-slate-500 whitespace-pre-wrap leading-relaxed">{{ user_input.plan | trim}}</div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-indigo-100 h-[18rem] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b bg-indigo-50/30 font-bold text-indigo-700 text-[14px] flex items-center gap-2 uppercase tracking-wider">
                <i data-lucide="shield-check" class="w-4 h-4"></i> Revised Strategy
            </div>
            <div class="p-6 overflow-y-auto text-[15px] text-slate-800 leading-relaxed font-medium">
                {{ current.revised_plan }}
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-red-100 h-[40rem] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b bg-red-50/30 font-bold text-red-700 text-[14px] flex items-center gap-2 uppercase tracking-wider">
                <i data-lucide="alert-octagon" class="w-4 h-4"></i> Identified Weaknesses
            </div>
            <div class="p-6 overflow-y-auto space-y-3">
                {% for p in current.problems %}
                <div class="p-4 bg-white rounded-xl border border-slate-100 flex justify-between items-start gap-4 hover:border-red-200 transition-colors">
                    <div class="flex-1">
                        <h4 class="font-bold text-slate-900 text-[14px] mb-1">{{ p.title }}</h4>
                        <p class="text-[14px] text-slate-600">{{ p.desc }}</p>
                    </div>
                    <div class="flex gap-1 shrink-0 binary-controls" data-type="problem" data-idx="{{ loop.index0 }}">
                        <button onclick="setBinary('problem', {{ loop.index0 }}, true, this)"
                                class="like-btn p-1.5 rounded-md transition-all
                                {% if p.liked == True %}
                                    bg-emerald-500 text-white shadow-md hover:bg-emerald-400
                                {% else %}
                                    text-slate-300 hover:text-emerald-500 hover:bg-emerald-50
                                {% endif %}">
                            <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                        </button>
                        <button onclick="setBinary('problem', {{ loop.index0 }}, false, this)"
                                class="dislike-btn p-1.5 rounded-md transition-all
                                {% if p.liked == False %}
                                    bg-rose-500 text-white shadow-md hover:bg-rose-400
                                {% else %}
                                    text-slate-300 hover:text-rose-500 hover:bg-rose-50
                                {% endif %}">
                            <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-emerald-100 h-[40rem] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b bg-emerald-50/30 font-bold text-emerald-700 text-[14px] flex items-center gap-2 uppercase tracking-wider">
                <i data-lucide="sparkles" class="w-4 h-4"></i> Strategic Improvements
            </div>
            <div class="p-6 overflow-y-auto space-y-3">
                {% for i in current.improvements %}
                <div class="p-4 bg-white rounded-xl border border-slate-100 flex justify-between items-start gap-4 hover:border-emerald-200 transition-colors">
                    <div class="flex-1">
                        <h4 class="font-bold text-slate-900 text-[14px] mb-1">{{ i.title }}</h4>
                        <p class="text-[14px] text-slate-600">{{ i.desc }}</p>
                    </div>
                    <div class="flex gap-1 shrink-0 binary-controls" data-type="improvement" data-idx="{{ loop.index0 }}">
                        <button onclick="setBinary('improvement', {{ loop.index0 }}, true, this)"
                                class="like-btn p-1.5 rounded-md transition-all
                                {% if i.liked == True %}
                                    bg-emerald-500 text-white shadow-md hover:bg-emerald-400
                                {% else %}
                                    text-slate-300 hover:text-emerald-500 hover:bg-emerald-50
                                {% endif %}">
                            <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                        </button>
                        <button onclick="setBinary('improvement', {{ loop.index0 }}, false, this)"
                                class="dislike-btn p-1.5 rounded-md transition-all
                                {% if i.liked == False %}
                                    bg-rose-500 text-white shadow-md hover:bg-rose-400
                                {% else %}
                                    text-slate-300 hover:text-rose-500 hover:bg-rose-50
                                {% endif %}">
                            <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <section class="mb-16">
        <div class="flex items-center gap-3 mb-8 px-2">
            <h2 class="text-xl font-bold text-slate-900">Timeline Summary</h2>
            <button type="button" onclick="toggleScoreModal(true)" class="w-7 h-7 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center hover:bg-slate-300 transition-colors shadow-sm" title="Explain Scores">
                <i data-lucide="help-circle" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for choice in maze_choices %}
            <div class="relative bg-white rounded-xl border border-slate-200 p-6 shadow-sm hover-card">
                <div class="absolute -top-3 left-4 px-2 py-0.5 bg-cyan-100 text-cyan-800 text-[11px] font-bold rounded uppercase tracking-wider z-10">
                    Obstacle {{ loop.index }}
                </div>

                <h5 class="font-bold text-slate-900 text-[15px] mb-2 leading-tight">{{ choice.title }}</h5>

                {% set option_text = choice.answer.split('[')[0].strip() %}
                <p class="text-[14px] text-slate-600 mb-4 leading-relaxed">
                    {{ option_text }}
                </p>

                {% if '[' in choice.answer %}
                <div class="flex flex-wrap gap-2 border-t border-slate-50 pt-3">
                    {% set scores = choice.answer.split('[')[1].split(']')[0].split(',') %}
                    {% for s in scores %}
                        {% set score_parts = s.split(':') %}
                        {% set label = score_parts[0].strip() %}
                        {% set val = score_parts[1].strip() | int %}

                        {% if label == 'Feasibility' %}
                            {% set color = 'text-emerald-600 bg-emerald-50' if val >= 8 else 'text-amber-600 bg-amber-50' if val >= 4 else 'text-rose-600 bg-rose-50' %}
                        {% else %}
                            {% set color = 'text-emerald-600 bg-emerald-50' if val <= 3 else 'text-amber-600 bg-amber-50' if val <= 7 else 'text-rose-600 bg-rose-50' %}
                        {% endif %}
                        <span class="text-[11px] font-black uppercase px-2 py-1 rounded {{ color }}">{{ label }}: {{ val }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>

    <section class="bg-indigo-50/30 border border-indigo-200 rounded-[2.5rem] p-10 text-slate-900 flex flex-col lg:flex-row gap-12 relative overflow-hidden shadow-sm">
        <i data-lucide="message-square" class="absolute -top-10 -right-10 w-48 h-48 text-indigo-100/50"></i>

        <div class="flex-1 relative z-10">
            <form id="refineForm" action="/refine" method="POST">
                <h3 class="text-2xl font-extrabold mb-4 tracking-tight">Revise The Strategy</h3>
                <p class="text-slate-500 text-[16px] mb-6">
                    Currently revising <span class="font-bold text-amber-700">Version {{ session.current_v_idx + 1 }}</span>.
                    Your adjustments will generate a new strategic iteration.
                </p>

                <textarea id="feedbackText" name="feedback" oninput="validateFeedback()"
                    class="w-full h-32 bg-white border border-indigo-100 rounded-2xl p-4 text-[16px] text-slate-700 placeholder:text-slate-400 focus:ring-2 focus:ring-indigo-500 outline-none resize-none mb-6 transition-all"
                    placeholder="e.g. Focus more on organic growth..."></textarea>

                <div class="flex flex-col md:flex-row items-center gap-4">
                    <button id="sendBtn" type="submit" disabled
                        class="w-full md:w-auto px-10 py-4 bg-indigo-900 text-white rounded-xl font-bold hover:bg-indigo-950/90 transition-all shadow-lg shadow-indigo-200/50 disabled:opacity-30 disabled:cursor-not-allowed">
                        Update Strategy
                    </button>

                    <div class="w-full md:w-64 relative">
                        <select name="pessimism"
                            class="w-full appearance-none bg-white border border-indigo-100 rounded-xl px-4 py-4 text-[15px] font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer">
                            {% for level in ["Optimistic", "Slightly Concerned", "Realistic", "Pessimistic", "Total Chaos"] %}
                            <option value="{{ level }}" {% if user_input.pessimism == level %}selected{% endif %}>{{ level }}</option>
                            {% endfor %}
                        </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="w-full lg:w-96 relative z-10 lg:border-l lg:border-indigo-200 lg:pl-12">
            <h4 class="font-bold text-indigo-900/60 text-[14px] uppercase tracking-widest mb-6 flex items-center gap-2">
                <i data-lucide="history" class="w-4 h-4"></i> Notes History
            </h4>
            <div class="space-y-4 max-h-[350px] overflow-y-auto pr-4 custom-scroll">
                {% for v in versions|reverse %}
                {% set actual_idx = versions|length - 1 - loop.index0 %}
                <a href="/set_version/{{ actual_idx }}"
                   class="block p-5 rounded-2xl border-l-4 transition-all group bg-white shadow-sm border-white
                   {{ 'border-l-amber-600 hover:bg-amber-50/40' if actual_idx == session.current_v_idx else 'border-l-transparent hover:bg-amber-100/40 hover:border-amber-400/40' }}">

                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[11px] font-black uppercase tracking-widest {{ 'text-amber-600' if actual_idx == session.current_v_idx else 'text-slate-400' }}">
                            version {{ actual_idx + 1 }}
                        </span>
                        <span class="text-[11px] text-slate-400 font-bold uppercase">{{ v.timestamp }}</span>
                    </div>

                    <p class="text-[13px] leading-relaxed {{ 'text-slate-900 font-medium' if actual_idx == session.current_v_idx else 'text-slate-500' }} line-clamp-1">
                        {{ v.notes }}
                    </p>

                    {% if actual_idx == session.current_v_idx %}
                    <span class="inline-block mt-2 text-[11px] font-bold text-amber-600/60 tracking-tighter">Currently Viewing</span>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        </div>
    </section>
</div>

<div id="scoreModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden fade-in">
        <div class="p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-900">Scoring Rubric</h3>
                <button type="button" onclick="toggleScoreModal(false)" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="px-2 py-0.5 bg-cyan-100 text-cyan-700 text-[12px] font-black uppercase rounded">Stress</span>
                    </div>
                    <p class="text-[16px] text-slate-600 leading-relaxed mb-3">Reflects the emotional and operational toll this solution requires.</p>
                    <div class="grid grid-cols-2 gap-3 text-[14px]">
                        <div><span class="px-1 py-0.5 font-bold bg-emerald-100 text-emerald-700 rounded">1/10</span> A minor task; zero risk.</div>
                        <div><span class="px-1 py-0.5 font-bold bg-red-100 text-red-700 rounded">10/10</span> Emergency state; high burnout risk.</div>
                    </div>
                </div>

                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="px-2 py-0.5 bg-cyan-100 text-cyan-700 text-[11px] font-black uppercase rounded">Deviation</span>
                    </div>
                    <p class="text-[16px] text-slate-600 leading-relaxed mb-3">Measures how much this solution changes your original intent.</p>
                    <div class="grid grid-cols-2 gap-3 text-[14px]">
                        <div><span class="px-1 py-0.5 font-bold bg-emerald-100 text-emerald-700 rounded">1/10</span> Virtually identical to original plan.</div>
                        <div><span class="px-1 py-0.5 font-bold bg-red-100 text-red-700 rounded">10/10</span> Total pivot or starting over.</div>
                    </div>
                </div>

                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="px-2 py-0.5 bg-cyan-100 text-cyan-700 text-[11px] font-black uppercase rounded">Feasibility</span>
                    </div>
                    <p class="text-[16px] text-slate-600 leading-relaxed mb-3">The likelihood that you can actually achieve this with current resources.</p>
                    <div class="grid grid-cols-2 gap-3 text-[14px]">
                        <div><span class="px-1 py-0.5 font-bold bg-red-100 text-red-700 rounded">1/10</span> Requires "magic" or 10x budget.</div>
                        <div><span class="px-1 py-0.5 font-bold bg-emerald-100 text-emerald-700 rounded">10/10</span> Uses existing skills and budget.</div>
                    </div>
                </div>
            </div>

            <button type="button" onclick="toggleScoreModal(false)" class="w-full mt-8 py-4 bg-amber-700 text-white font-bold rounded-xl shadow-lg hover:bg-amber-800 transition-all">
                Got it
            </button>
        </div>
    </div>
</div>

<div id="helpModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden fade-in">
        <div class="p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-[22px] font-bold text-slate-900">Dashboard Guide</h3>
                <button type="button" onclick="toggleHelpModal(false)" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div class="flex gap-4">
                    <div class="w-10 h-10 shrink-0 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="thumbs-up" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-[17px] text-slate-900 mb-1">Rate the Analysis</h4>
                        <p class="text-slate-600 text-[15px] leading-relaxed">Use the <span class="font-bold">like/dislike</span> buttons on weaknesses and improvements. This teaches the system what aspects of the strategy you value most.</p>
                    </div>
                </div>

                <div class="flex gap-4">
                    <div class="w-10 h-10 shrink-0 bg-amber-100 text-amber-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-[17px] text-slate-900 mb-1">Iterate & Compare</h4>
                        <p class="text-slate-600 text-[15px] leading-relaxed">Use the <span class="font-bold">Update Strategy</span> section to provide feedback. You can switch between previous versions using the <span class="font-bold">Notes History</span> sidebar to track progress.</p>
                    </div>
                </div>

                <div class="flex gap-4">
                    <div class="w-10 h-10 shrink-0 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-[17px] text-slate-900 mb-1">Finalize Strategy</h4>
                        <p class="text-slate-600 text-[15px] leading-relaxed">Once you are satisfied with the revised plan, click the <span class="font-bold">Finish</span> button to generate your final execution roadmap and followup dashboard.</p>
                    </div>
                </div>
            </div>

            <button type="button" onclick="toggleHelpModal(false)" class="w-full mt-8 py-4 bg-amber-700 text-white font-bold rounded-xl shadow-lg hover:bg-amber-800 transition-all">
                Start Reviewing
            </button>
        </div>
    </div>
</div>

<script>
    function toggleScoreModal(show) {
        const modal = document.getElementById('scoreModal');
        modal.classList.toggle('hidden', !show);
        modal.classList.toggle('flex', show);
    }

    function toggleHelpModal(show) {
        const modal = document.getElementById('helpModal');
        modal.classList.toggle('hidden', !show);
        modal.classList.toggle('flex', show);
    }

    function validateFeedback() {
        const text = document.getElementById('feedbackText').value.trim();
        const sendBtn = document.getElementById('sendBtn');
        const currentProblems = {{ current.problems | tojson }};
        const currentImps = {{ current.improvements | tojson }};
        const hasBinary = currentProblems.some(p => p.liked !== null) || currentImps.some(i => i.liked !== null);

        if (text.length > 0 || hasBinary) {
            sendBtn.disabled = false;
        } else {
            sendBtn.disabled = true;
        }
    }

    window.onload = validateFeedback;

    async function setBinary(type, idx, liked, btnElement) {
        const container = btnElement.closest('.binary-controls');
        const likeBtn = container.querySelector('.like-btn');
        const dislikeBtn = container.querySelector('.dislike-btn');
        const isAlreadyActive = (liked && btnElement.classList.contains('bg-emerald-500')) ||
                                (!liked && btnElement.classList.contains('bg-rose-500'));
        const finalLikedValue = isAlreadyActive ? null : liked;

        likeBtn.classList.remove('bg-emerald-500', 'hover:bg-emerald-400', 'text-white', 'shadow-md');
        likeBtn.classList.add('text-slate-300', 'hover:text-emerald-500', 'hover:bg-emerald-50');
        dislikeBtn.classList.remove('bg-rose-500', 'hover:bg-rose-400', 'text-white', 'shadow-md');
        dislikeBtn.classList.add('text-slate-300', 'hover:text-rose-500', 'hover:bg-rose-50');

        if (finalLikedValue === true) {
            likeBtn.classList.remove('text-slate-300', 'hover:text-emerald-500', 'hover:bg-emerald-50');
            likeBtn.classList.add('bg-emerald-500', 'text-white', 'shadow-md', 'hover:bg-emerald-400');
        } else if (finalLikedValue === false) {
            dislikeBtn.classList.remove('text-slate-300', 'hover:text-rose-500', 'hover:bg-rose-50');
            dislikeBtn.classList.add('bg-rose-500', 'text-white', 'shadow-md', 'hover:bg-rose-400');
        }

        try {
            await fetch('/feedback_binary', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type, idx, liked: finalLikedValue})
            });
            validateFeedback();
        } catch (err) {
            console.error("Error updating feedback:", err);
        }
    }
</script>
{% endblock %}